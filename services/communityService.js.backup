const { Sequelize, DataTypes } = require('sequelize');
const axios = require('axios');

// PostgreSQL RDS ì—°ê²° ì„¤ì •
const sequelize = new Sequelize(
  process.env.DB_NAME || 'jjikgeo',
  process.env.DB_USER || 'postgres',
  process.env.DB_PASSWORD,
  {
    host: process.env.DB_HOST || 'final-db.cz420qs4q66k.ap-northeast-1.rds.amazonaws.com',
    port: process.env.DB_PORT || 5432,
    dialect: 'postgres',
    logging: process.env.NODE_ENV === 'development' ? console.log : false,
    timezone: '+09:00',
    pool: {
      max: 20,
      min: 0,
      acquire: 30000,
      idle: 10000
    },
    dialectOptions: {
      ssl: process.env.NODE_ENV === 'production' ? {
        require: true,
        rejectUnauthorized: false
      } : false
    }
  }
);

// ì‚¬ìš©ì ëª¨ë¸
const User = sequelize.define('User', {
  id: {
    type: DataTypes.STRING,
    primaryKey: true
  },
  name: {
    type: DataTypes.STRING,
    allowNull: false
  },
  level: {
    type: DataTypes.STRING,
    defaultValue: 'Lv.1'
  }
}, {
  tableName: 'users',
  timestamps: true,
  createdAt: 'created_at',
  updatedAt: 'updated_at'
});

// ê²Œì‹œê¸€ ëª¨ë¸
const Post = sequelize.define('Post', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  boardId: {
    type: DataTypes.STRING,
    allowNull: false
  },
  title: {
    type: DataTypes.STRING,
    allowNull: false
  },
  content: {
    type: DataTypes.TEXT,
    allowNull: false
  },
  category: {
    type: DataTypes.STRING,
    defaultValue: 'ì¼ë°˜'
  },
  authorId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: User,
      key: 'id'
    }
  },
  author: {
    type: DataTypes.STRING,
    allowNull: false
  },
  authorLevel: {
    type: DataTypes.STRING,
    allowNull: false
  },
  likes: {
    type: DataTypes.INTEGER,
    defaultValue: 0
  },
  views: {
    type: DataTypes.INTEGER,
    defaultValue: 0
  },
  images: {
    type: DataTypes.JSON,
    allowNull: true
  }
});

// ëŒ“ê¸€ ëª¨ë¸
const Comment = sequelize.define('Comment', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  postId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: Post,
      key: 'id'
    }
  },
  authorId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: User,
      key: 'id'
    }
  },
  author: {
    type: DataTypes.STRING,
    allowNull: false
  },
  authorLevel: {
    type: DataTypes.STRING,
    allowNull: false
  },
  content: {
    type: DataTypes.TEXT,
    allowNull: false
  }
});

// ì¢‹ì•„ìš” ëª¨ë¸
const Like = sequelize.define('Like', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  postId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: Post,
      key: 'id'
    }
  },
  userId: {
    type: DataTypes.INTEGER,
    allowNull: false,
    references: {
      model: User,
      key: 'id'
    }
  }
});

// ê´€ê´‘ì§€ ëª¨ë¸
const TouristSpot = sequelize.define('TouristSpot', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  contentId: {
    type: DataTypes.STRING,
    allowNull: false,
    unique: true
  },
  title: {
    type: DataTypes.STRING,
    allowNull: false
  },
  addr1: {
    type: DataTypes.STRING,
    allowNull: true
  },
  addr2: {
    type: DataTypes.STRING,
    allowNull: true
  },
  areaCode: {
    type: DataTypes.STRING,
    allowNull: true,
    index: true
  },
  cat1: {
    type: DataTypes.STRING,
    allowNull: true
  },
  cat2: {
    type: DataTypes.STRING,
    allowNull: true
  },
  cat3: {
    type: DataTypes.STRING,
    allowNull: true
  },
  contentTypeId: {
    type: DataTypes.STRING,
    allowNull: true,
    index: true
  },
  firstImage: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  firstImage2: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  mapX: {
    type: DataTypes.DECIMAL(10, 7),
    allowNull: true,
    index: true
  },
  mapY: {
    type: DataTypes.DECIMAL(10, 7),
    allowNull: true
  },
  tel: {
    type: DataTypes.STRING,
    allowNull: true
  },
  zipcode: {
    type: DataTypes.STRING,
    allowNull: true
  },
  overview: {
    type: DataTypes.TEXT,
    allowNull: true
  },
  modifiedTime: {
    type: DataTypes.STRING,
    allowNull: true
  }
});

// ê´€ê³„ ì„¤ì •
Post.belongsTo(User, { foreignKey: 'authorId', onDelete: 'CASCADE' });
Comment.belongsTo(Post, { foreignKey: 'postId', onDelete: 'CASCADE' });
Comment.belongsTo(User, { foreignKey: 'authorId', onDelete: 'CASCADE' });
Like.belongsTo(Post, { foreignKey: 'postId', onDelete: 'CASCADE' });
Like.belongsTo(User, { foreignKey: 'userId', onDelete: 'CASCADE' });

class CommunityService {
  constructor() {
    this.sequelize = sequelize;
    this.User = User;
    this.Post = Post;
    this.Comment = Comment;
    this.Like = Like;
    this.TouristSpot = TouristSpot;
  }

  // í•œêµ­ê´€ê´‘ê³µì‚¬ ìœ„ì¹˜ê¸°ë°˜ API - ê°€ê¹Œìš´ ê´€ê´‘ì§€ ì¡°íšŒ
  async fetchNearbyTouristSpotsFromAPI(latitude, longitude, radius = 10000, limit = 10) {
    try {
      // í™˜ê²½ë³€ìˆ˜ì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
      const apiKey = process.env.TOUR_API_KEY;
      
      if (!apiKey) {
        console.log('âš ï¸ TOUR_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ API ì¡°íšŒë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
        return [];
      }
      
      console.log(`ğŸ›ï¸ ìœ„ì¹˜ê¸°ë°˜ ê´€ê´‘ì§€ ì¡°íšŒ: ${latitude}, ${longitude} (ë°˜ê²½: ${radius}m)`);

      const baseUrl = 'https://apis.data.go.kr/B551011/KorService2/locationBasedList2';
      const params = {
        serviceKey: apiKey,
        numOfRows: limit.toString(),
        pageNo: '1',
        MobileOS: 'ETC',
        MobileApp: 'JjikJio',
        _type: 'json',
        arrange: 'E', // ê±°ë¦¬ìˆœ ì •ë ¬
        mapX: longitude.toString(),
        mapY: latitude.toString(),
        radius: radius.toString(),
        contentTypeId: '12', // ê´€ê´‘ì§€
        areaCode: '1' // ì„œìš¸
      };

      console.log('ğŸ” API ìš”ì²­ íŒŒë¼ë¯¸í„°:', { ...params, serviceKey: '***' });

      const response = await axios.get(baseUrl, { 
        params,
        timeout: 10000 // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
      });
      
      console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);
      
      if (response.data && response.data.response) {
        const header = response.data.response.header;
        const body = response.data.response.body;
        
        console.log('ğŸ“‹ API ì‘ë‹µ í—¤ë”:', header);
        
        if (header && header.resultCode === '0000') {
          const items = body && body.items ? body.items.item : [];
          const itemsArray = Array.isArray(items) ? items : (items ? [items] : []);
          
          console.log(`âœ… ê´€ê´‘ê³µì‚¬ API ì‘ë‹µ: ${itemsArray.length}ê°œ ê´€ê´‘ì§€`);
          return itemsArray;
        } else {
          const errorMsg = header ? header.resultMsg : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
          throw new Error(`API ì˜¤ë¥˜: ${errorMsg}`);
        }
      } else {
        throw new Error('API ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('âŒ ê´€ê´‘ê³µì‚¬ ìœ„ì¹˜ê¸°ë°˜ API í˜¸ì¶œ ì˜¤ë¥˜:', error.message);
      if (error.response) {
        console.error('âŒ API ì‘ë‹µ ì˜¤ë¥˜:', error.response.status, error.response.data);
      }
      throw error;
    }
  }

  // í•œêµ­ê´€ê´‘ê³µì‚¬ API - ì„œìš¸ ê´€ê´‘ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì§€ì—­ê¸°ë°˜)
  async fetchSeoulTouristSpots() {
    try {
      // ì œê³µë°›ì€ ì¸ì¦í‚¤ ì‚¬ìš©
      const apiKey = 'jXbeQ98Dvep6SzEFu8ulcLjvOeUWdY107O4fsq9SUJ0PQkDsUPXrm8gmZ8hKCnSSEEF6iM4Le8oMeyhqLrD3MQ==';
      
      console.log('ğŸ›ï¸ ì„œìš¸ ê´€ê´‘ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');

      const baseUrl = 'https://apis.data.go.kr/B551011/KorService2/areaBasedList2';
      const params = {
        serviceKey: apiKey,
        numOfRows: '100',
        pageNo: '1',
        MobileOS: 'ETC',
        MobileApp: 'JjikJio',
        _type: 'json',
        arrange: 'A', // ì œëª©ìˆœ
        contentTypeId: '12', // ê´€ê´‘ì§€
        areaCode: '1' // ì„œìš¸
      };

      console.log('ğŸ“¡ API í˜¸ì¶œ URL:', baseUrl);
      console.log('ğŸ“¡ API íŒŒë¼ë¯¸í„°:', params);

      const response = await axios.get(baseUrl, { params });
      
      console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);
      console.log('ğŸ“¡ API ì‘ë‹µ êµ¬ì¡°:', JSON.stringify(response.data, null, 2));
      
      // ìƒˆë¡œìš´ API ì‘ë‹µ êµ¬ì¡° ì²˜ë¦¬
      if (response.data && response.data.response) {
        const header = response.data.response.header;
        const body = response.data.response.body;
        
        if (header && header.resultCode === '0000') {
          const items = body && body.items ? body.items.item : [];
          const itemsArray = Array.isArray(items) ? items : [items];
          
          console.log(`âœ… ê´€ê´‘ê³µì‚¬ API ì‘ë‹µ: ${itemsArray.length}ê°œ ê´€ê´‘ì§€`);
          return itemsArray;
        } else {
          const errorMsg = header ? header.resultMsg : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
          throw new Error(`API ì˜¤ë¥˜: ${errorMsg}`);
        }
      } else if (response.data && response.data.resultCode) {
        // ìƒˆë¡œìš´ ì‘ë‹µ êµ¬ì¡° ì²˜ë¦¬
        if (response.data.resultCode === '0000') {
          const items = response.data.items ? response.data.items.item : [];
          const itemsArray = Array.isArray(items) ? items : [items];
          
          console.log(`âœ… ê´€ê´‘ê³µì‚¬ API ì‘ë‹µ: ${itemsArray.length}ê°œ ê´€ê´‘ì§€`);
          return itemsArray;
        } else {
          throw new Error(`API ì˜¤ë¥˜: ${response.data.resultMsg}`);
        }
      } else {
        console.error('âŒ ì˜ˆìƒê³¼ ë‹¤ë¥¸ API ì‘ë‹µ êµ¬ì¡°:', response.data);
        throw new Error('API ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('âŒ ê´€ê´‘ê³µì‚¬ API í˜¸ì¶œ ì˜¤ë¥˜:', error.message);
      if (error.response) {
        console.error('âŒ API ì‘ë‹µ ì˜¤ë¥˜:', error.response.status, error.response.data);
      }
      throw error;
    }
  }

  // ì„œìš¸ ê´€ê´‘ì§€ ë°ì´í„°ë¥¼ PostgreSQL RDSì— ì €ì¥
  async saveSeoulTouristSpots() {
    try {
      console.log('ğŸ’¾ ì„œìš¸ ê´€ê´‘ì§€ ë°ì´í„° ì €ì¥ ì‹œì‘...');
      
      const touristSpots = await this.fetchSeoulTouristSpots();
      let savedCount = 0;
      let updatedCount = 0;

      for (const spot of touristSpots) {
        try {
          const [touristSpot, created] = await TouristSpot.upsert({
            contentId: spot.contentid,
            title: spot.title,
            addr1: spot.addr1,
            addr2: spot.addr2,
            areaCode: spot.areacode,
            cat1: spot.cat1,
            cat2: spot.cat2,
            cat3: spot.cat3,
            contentTypeId: spot.contenttypeid,
            firstImage: spot.firstimage,
            firstImage2: spot.firstimage2,
            mapX: spot.mapx ? parseFloat(spot.mapx) : null,
            mapY: spot.mapy ? parseFloat(spot.mapy) : null,
            tel: spot.tel,
            zipcode: spot.zipcode,
            modifiedTime: spot.modifiedtime
          });

          if (created) {
            savedCount++;
          } else {
            updatedCount++;
          }
        } catch (itemError) {
          console.error(`ê´€ê´‘ì§€ ì €ì¥ ì˜¤ë¥˜ (${spot.title}):`, itemError.message);
        }
      }

      console.log(`âœ… ì„œìš¸ ê´€ê´‘ì§€ ì €ì¥ ì™„ë£Œ: ì‹ ê·œ ${savedCount}ê°œ, ì—…ë°ì´íŠ¸ ${updatedCount}ê°œ`);
      return { saved: savedCount, updated: updatedCount, total: touristSpots.length };
    } catch (error) {
      console.error('âŒ ì„œìš¸ ê´€ê´‘ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ê´€ê´‘ì§€ ìƒì„¸ì •ë³´ ì¡°íšŒ (RDS ìš°ì„ , API fallback)
  async getTouristSpotDetail(contentId) {
    try {
      console.log(`ğŸ” ê´€ê´‘ì§€ ìƒì„¸ì •ë³´ ì¡°íšŒ: ${contentId}`);

      // 1. RDSì—ì„œ ë¨¼ì € ì¡°íšŒ
      const rdsSpot = await TouristSpot.findOne({
        where: { contentId: contentId }
      });

      if (rdsSpot) {
        console.log(`âœ… RDSì—ì„œ ê´€ê´‘ì§€ ì •ë³´ ë°œê²¬: ${rdsSpot.title}`);
        
        // RDS ë°ì´í„°ë¥¼ API í˜•ì‹ì— ë§ê²Œ ë³€í™˜
        const rdsData = {
          contentid: rdsSpot.contentId,
          title: rdsSpot.title,
          addr1: rdsSpot.addr1,
          addr2: rdsSpot.addr2,
          areacode: rdsSpot.areaCode,
          cat1: rdsSpot.cat1,
          cat2: rdsSpot.cat2,
          cat3: rdsSpot.cat3,
          contenttypeid: rdsSpot.contentTypeId,
          firstimage: rdsSpot.firstImage,
          firstimage2: rdsSpot.firstImage2,
          mapx: rdsSpot.mapX,
          mapy: rdsSpot.mapY,
          tel: rdsSpot.tel,
          zipcode: rdsSpot.zipcode,
          modifiedtime: rdsSpot.modifiedTime,
          // ê¸°ë³¸ ì„¤ëª… ì¶”ê°€
          overview: `${rdsSpot.title}ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ì…ë‹ˆë‹¤.`,
          homepage: '',
          telname: '',
          // RDS ë°ì´í„°ì„ì„ í‘œì‹œ
          dataSource: 'RDS'
        };

        return rdsData;
      }

      // 2. RDSì— ì—†ìœ¼ë©´ APIì—ì„œ ì¡°íšŒ
      console.log(`ğŸ”„ RDSì— ì—†ìŒ - APIì—ì„œ ì¡°íšŒ: ${contentId}`);
      return await this.fetchTouristSpotDetailFromAPI(contentId);

    } catch (error) {
      console.error('âŒ ê´€ê´‘ì§€ ìƒì„¸ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error.message);
      throw error;
    }
  }

  // í•œêµ­ê´€ê´‘ê³µì‚¬ APIì—ì„œ ê´€ê´‘ì§€ ìƒì„¸ì •ë³´ ì¡°íšŒ
  async fetchTouristSpotDetailFromAPI(contentId) {
    try {
      // í•˜ë“œì½”ë”©ëœ API í‚¤ ì‚¬ìš© (fallbackìš©)
      const apiKey = 'jXbeQ98Dvep6SzEFu8ulcLjvOeUWdY107O4fsq9SUJ0PQkDsUPXrm8gmZ8hKCnSSEEF6iM4Le8oMeyhqLrD3MQ==';
      
      console.log(`ğŸ” APIì—ì„œ ê´€ê´‘ì§€ ìƒì„¸ì •ë³´ ì¡°íšŒ: ${contentId}`);

      // 1. ê¸°ë³¸ ìƒì„¸ì •ë³´ ì¡°íšŒ
      const detailUrl = 'https://apis.data.go.kr/B551011/KorService2/detailCommon2';
      const detailParams = {
        serviceKey: apiKey,
        numOfRows: '10',
        pageNo: '1',
        MobileOS: 'ETC',
        MobileApp: 'JjikJio',
        _type: 'json',
        contentId: contentId
      };

      const detailResponse = await axios.get(detailUrl, { params: detailParams });
      
      let detailInfo = {};
      if (detailResponse.data && detailResponse.data.response && 
          detailResponse.data.response.header.resultCode === '0000') {
        const items = detailResponse.data.response.body.items.item;
        const itemsArray = Array.isArray(items) ? items : [items];
        if (itemsArray.length > 0) {
          detailInfo = itemsArray[0];
        }
      }

      // 2. ì†Œê°œì •ë³´ ì¡°íšŒ (ì´ìš©ì‹œê°„, ìš”ê¸ˆ ë“±)
      const introUrl = 'https://apis.data.go.kr/B551011/KorService2/detailIntro2';
      const introParams = {
        serviceKey: apiKey,
        numOfRows: '10',
        pageNo: '1',
        MobileOS: 'ETC',
        MobileApp: 'JjikJio',
        _type: 'json',
        contentId: contentId,
        contentTypeId: '12' // ê´€ê´‘ì§€
      };

      const introResponse = await axios.get(introUrl, { params: introParams });
      
      let introInfo = {};
      if (introResponse.data && introResponse.data.response && 
          introResponse.data.response.header.resultCode === '0000') {
        const items = introResponse.data.response.body.items.item;
        const itemsArray = Array.isArray(items) ? items : [items];
        if (itemsArray.length > 0) {
          introInfo = itemsArray[0];
        }
      }

      // 3. ì •ë³´ í†µí•©
      const combinedInfo = {
        // ê¸°ë³¸ ì •ë³´
        contentId: detailInfo.contentid || contentId,
        title: detailInfo.title || 'ì •ë³´ ì—†ìŒ',
        addr1: detailInfo.addr1 || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ',
        addr2: detailInfo.addr2 || '',
        tel: detailInfo.tel || introInfo.infocenter || 'ì „í™”ë²ˆí˜¸ ì •ë³´ ì—†ìŒ',
        homepage: detailInfo.homepage || '',
        overview: detailInfo.overview || 'ì„¤ëª… ì •ë³´ ì—†ìŒ',
        firstImage: detailInfo.firstimage || '',
        firstImage2: detailInfo.firstimage2 || '',
        mapX: detailInfo.mapx || '',
        mapY: detailInfo.mapy || '',
        zipcode: detailInfo.zipcode || '',
        
        // ìƒì„¸ ì •ë³´ (ì†Œê°œì •ë³´ì—ì„œ)
        usetime: introInfo.usetime || 'ì´ìš©ì‹œê°„ ì •ë³´ ì—†ìŒ',
        restdate: introInfo.restdate || 'íœ´ë¬´ì¼ ì •ë³´ ì—†ìŒ',
        usefee: introInfo.usefee || 'ìš”ê¸ˆ ì •ë³´ ì—†ìŒ',
        parking: introInfo.parking || 'ì£¼ì°¨ì¥ ì •ë³´ ì—†ìŒ',
        chkbabycarriage: introInfo.chkbabycarriage || '',
        chkpet: introInfo.chkpet || '',
        chkcreditcard: introInfo.chkcreditcard || '',
        infocenter: introInfo.infocenter || detailInfo.tel || 'ë¬¸ì˜ì²˜ ì •ë³´ ì—†ìŒ',
        
        // ì¶”ê°€ í¸ì˜ì‹œì„¤ ì •ë³´
        restroom: introInfo.restroom || '',
        smoking: introInfo.smoking || '',
        guidebook: introInfo.guidebook || '',
        audioguide: introInfo.audioguide || ''
      };

      console.log(`âœ… ê´€ê´‘ì§€ ìƒì„¸ì •ë³´ ì¡°íšŒ ì™„ë£Œ: ${combinedInfo.title}`);
      return combinedInfo;

    } catch (error) {
      console.error('âŒ ê´€ê´‘ì§€ ìƒì„¸ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error.message);
      if (error.response) {
        console.error('âŒ API ì‘ë‹µ ì˜¤ë¥˜:', error.response.status, error.response.data);
      }
      throw error;
    }
  }

  // GPS ê¸°ë°˜ ê°€ê¹Œìš´ ê´€ê´‘ì§€ ì¡°íšŒ (ë©”ì¸í˜ì´ì§€ìš© - RDS ìš°ì„ )
  async getNearbyTouristSpots(latitude, longitude, limit = 3) {
    try {
      console.log(`ğŸ” ê°€ê¹Œìš´ ê´€ê´‘ì§€ ê²€ìƒ‰ (RDS): ${latitude}, ${longitude}`);

      // RDSì—ì„œ ì§ì ‘ ì¡°íšŒ (ê±°ë¦¬ ê³„ì‚° í¬í•¨)
      const query = `
        SELECT *, distance FROM (
          SELECT *,
          (6371 * acos(cos(radians(:latitude)) * cos(radians("mapY")) * 
          cos(radians("mapX") - radians(:longitude)) + sin(radians(:latitude)) * 
          sin(radians("mapY")))) AS distance
          FROM "TouristSpots"
          WHERE "mapX" IS NOT NULL AND "mapY" IS NOT NULL
        ) AS subquery
        WHERE distance <= 20
        ORDER BY distance ASC
        LIMIT :limit
      `;

      const nearbySpots = await sequelize.query(query, {
        replacements: { latitude, longitude, limit },
        type: sequelize.QueryTypes.SELECT
      });

      console.log(`âœ… RDSì—ì„œ ê°€ê¹Œìš´ ê´€ê´‘ì§€ ${nearbySpots.length}ê°œ ë°œê²¬`);
      
      // ë°ì´í„° í˜•ì‹ í†µì¼
      const formattedSpots = nearbySpots.map(spot => ({
        contentId: spot.contentId,
        title: spot.title,
        addr1: spot.addr1,
        addr2: spot.addr2,
        areaCode: spot.areaCode,
        cat1: spot.cat1,
        cat2: spot.cat2,
        cat3: spot.cat3,
        contentTypeId: spot.contentTypeId,
        firstImage: spot.firstImage,
        firstImage2: spot.firstImage2,
        mapX: parseFloat(spot.mapX),
        mapY: parseFloat(spot.mapY),
        tel: spot.tel,
        zipcode: spot.zipcode,
        distance: parseFloat(spot.distance),
        modifiedTime: spot.modifiedTime
      }));

      return formattedSpots;
    } catch (error) {
      console.error('âŒ RDSì—ì„œ ê°€ê¹Œìš´ ê´€ê´‘ì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
      
      // RDS ì‹¤íŒ¨ ì‹œì—ë§Œ API í˜¸ì¶œ (fallback)
      try {
        console.log('ğŸ”„ RDS ì‹¤íŒ¨ - APIì—ì„œ ê´€ê´‘ì§€ ì¡°íšŒ ì‹œë„...');
        const apiSpots = await this.fetchNearbyTouristSpotsFromAPI(latitude, longitude, 10000, limit);
        
        // API ë°ì´í„°ë¥¼ ë©”ì¸í˜ì´ì§€ í˜•ì‹ì— ë§ê²Œ ë³€í™˜
        const formattedSpots = apiSpots.map(spot => ({
          contentId: spot.contentid,
          title: spot.title,
          addr1: spot.addr1,
          addr2: spot.addr2,
          areaCode: spot.areacode,
          cat1: spot.cat1,
          cat2: spot.cat2,
          cat3: spot.cat3,
          contentTypeId: spot.contenttypeid,
          firstImage: spot.firstimage,
          firstImage2: spot.firstimage2,
          mapX: parseFloat(spot.mapx),
          mapY: parseFloat(spot.mapy),
          tel: spot.tel,
          zipcode: spot.zipcode,
          distance: parseFloat(spot.dist) / 1000, // ë¯¸í„°ë¥¼ í‚¬ë¡œë¯¸í„°ë¡œ ë³€í™˜
          modifiedTime: spot.modifiedtime
        }));

        console.log(`âœ… API fallbackìœ¼ë¡œ ê´€ê´‘ì§€ ${formattedSpots.length}ê°œ ë°œê²¬`);
        return formattedSpots;
      } catch (fallbackError) {
        console.error('âŒ API fallbackë„ ì‹¤íŒ¨:', fallbackError);
        return []; // ë¹ˆ ë°°ì—´ ë°˜í™˜
      }
    }
  }

  // ê´€ê´‘ì§€ ì´ ê°œìˆ˜ ì¡°íšŒ
  async getTouristSpotCount() {
    try {
      const count = await TouristSpot.count();
      console.log(`ğŸ“Š ì €ì¥ëœ ê´€ê´‘ì§€ ì´ ê°œìˆ˜: ${count}ê°œ`);
      return count;
    } catch (error) {
      console.error('ê´€ê´‘ì§€ ê°œìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
      return 0;
    }
  }

  // RDS ê´€ê´‘ì§€ ìƒ˜í”Œ ë°ì´í„° ì¡°íšŒ (ë””ë²„ê¹…ìš©)
  async getSampleTouristSpots(limit = 5) {
    try {
      const sampleSpots = await TouristSpot.findAll({
        limit: limit,
        order: [['createdAt', 'DESC']],
        attributes: ['contentId', 'title', 'addr1', 'mapX', 'mapY', 'firstImage', 'createdAt']
      });
      
      console.log(`ğŸ“‹ ìƒ˜í”Œ ê´€ê´‘ì§€ ${sampleSpots.length}ê°œ ì¡°íšŒ`);
      return sampleSpots;
    } catch (error) {
      console.error('ìƒ˜í”Œ ê´€ê´‘ì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
      return [];
    }
  }

  // ê¸°ì¡´ ì»¤ë®¤ë‹ˆí‹° ê´€ë ¨ ë©”ì„œë“œë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€...
  // (ì—¬ê¸°ì„œëŠ” ìƒëµí•˜ê³  í•„ìš”ì‹œ ì¶”ê°€)
}

module.exports = new CommunityService();
  // ==================== ì»¤ë®¤ë‹ˆí‹° ê´€ë ¨ ë©”ì„œë“œ ====================

  // ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ
  async getPosts(boardId, userId = null, sortBy = 'latest', page = 1, limit = 10) {
    try {
      console.log(`ğŸ“‹ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ: boardId=${boardId}, sortBy=${sortBy}, page=${page}`);
      
      const offset = (page - 1) * limit;
      let orderBy = [['createdAt', 'DESC']]; // ê¸°ë³¸: ìµœì‹ ìˆœ
      
      if (sortBy === 'popular') {
        orderBy = [['likes', 'DESC'], ['views', 'DESC']];
      } else if (sortBy === 'views') {
        orderBy = [['views', 'DESC']];
      }

      const posts = await Post.findAll({
        where: { boardId },
        order: orderBy,
        limit: parseInt(limit),
        offset: parseInt(offset),
        include: [
          {
            model: Comment,
            attributes: ['id']
          }
        ]
      });

      const formattedPosts = posts.map(post => ({
        id: post.id,
        title: post.title,
        content: post.content,
        author: post.author,
        authorId: post.authorId,
        authorLevel: post.authorLevel,
        boardId: post.boardId,
        category: post.category,
        views: post.views || 0,
        likes: post.likes || 0,
        commentCount: post.Comments ? post.Comments.length : 0,
        images: post.images,
        createdAt: post.createdAt,
        updatedAt: post.updatedAt
      }));

      console.log(`âœ… ê²Œì‹œê¸€ ${formattedPosts.length}ê°œ ì¡°íšŒ ì™„ë£Œ`);
      return formattedPosts;
    } catch (error) {
      console.error('âŒ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ê²Œì‹œê¸€ ìƒì„±
  async createPost(postData) {
    try {
      console.log('ğŸ“ ìƒˆ ê²Œì‹œê¸€ ìƒì„±:', postData.title);
      
      const post = await Post.create({
        title: postData.title,
        content: postData.content,
        author: postData.author,
        authorId: postData.authorId,
        authorLevel: postData.authorLevel || 'Lv.1',
        boardId: postData.boardId,
        category: postData.category,
        images: postData.images || null,
        views: 0,
        likes: 0
      });

      console.log(`âœ… ê²Œì‹œê¸€ ìƒì„± ì™„ë£Œ: ID ${post.id}`);
      return post;
    } catch (error) {
      console.error('âŒ ê²Œì‹œê¸€ ìƒì„± ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
  async getPostDetail(postId, userId = null) {
    try {
      console.log(`ğŸ“– ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ: ${postId}`);
      
      // ì¡°íšŒìˆ˜ ì¦ê°€
      await Post.increment('views', { where: { id: postId } });
      
      const post = await Post.findByPk(postId, {
        include: [
          {
            model: Comment,
            order: [['createdAt', 'ASC']]
          }
        ]
      });

      if (!post) {
        throw new Error('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }

      console.log(`âœ… ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ ì™„ë£Œ: ${post.title}`);
      return post;
    } catch (error) {
      console.error('âŒ ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
  async getComments(postId) {
    try {
      console.log(`ğŸ’¬ ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ: postId=${postId}`);
      
      const comments = await Comment.findAll({
        where: { postId },
        order: [['createdAt', 'ASC']]
      });

      console.log(`âœ… ëŒ“ê¸€ ${comments.length}ê°œ ì¡°íšŒ ì™„ë£Œ`);
      return comments;
    } catch (error) {
      console.error('âŒ ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ëŒ“ê¸€ ìƒì„±
  async createComment(commentData) {
    try {
      console.log('ğŸ’¬ ìƒˆ ëŒ“ê¸€ ìƒì„±:', commentData.content.substring(0, 50));
      
      const comment = await Comment.create({
        content: commentData.content,
        author: commentData.author,
        authorId: commentData.authorId,
        authorLevel: commentData.authorLevel || 'Lv.1',
        postId: commentData.postId,
        likes: 0
      });

      console.log(`âœ… ëŒ“ê¸€ ìƒì„± ì™„ë£Œ: ID ${comment.id}`);
      return comment;
    } catch (error) {
      console.error('âŒ ëŒ“ê¸€ ìƒì„± ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ì¢‹ì•„ìš” í† ê¸€
  async toggleLike(postId, userId) {
    try {
      console.log(`ğŸ‘ ì¢‹ì•„ìš” í† ê¸€: postId=${postId}, userId=${userId}`);
      
      const existingLike = await Like.findOne({
        where: { postId, userId }
      });

      if (existingLike) {
        // ì¢‹ì•„ìš” ì·¨ì†Œ
        await existingLike.destroy();
        await Post.decrement('likes', { where: { id: postId } });
        console.log('âœ… ì¢‹ì•„ìš” ì·¨ì†Œ ì™„ë£Œ');
        return { liked: false };
      } else {
        // ì¢‹ì•„ìš” ì¶”ê°€
        await Like.create({ postId, userId });
        await Post.increment('likes', { where: { id: postId } });
        console.log('âœ… ì¢‹ì•„ìš” ì¶”ê°€ ì™„ë£Œ');
        return { liked: true };
      }
    } catch (error) {
      console.error('âŒ ì¢‹ì•„ìš” í† ê¸€ ì˜¤ë¥˜:', error);
      throw error;
    }
  }

  // ê²Œì‹œíŒ í†µê³„
  async getBoardStats(boardId) {
    try {
      const totalPosts = await Post.count({ where: { boardId } });
      const totalComments = await Comment.count({
        include: [{
          model: Post,
          where: { boardId }
        }]
      });

      return {
        totalPosts,
        totalComments
      };
    } catch (error) {
      console.error('âŒ ê²Œì‹œíŒ í†µê³„ ì¡°íšŒ ì˜¤ë¥˜:', error);
      throw error;
    }
  }
}

module.exports = new CommunityService();
  // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
  async createTestData() {
    try {
      console.log('ğŸ”§ ì»¤ë®¤ë‹ˆí‹° í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±...');
      
      // í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ìƒì„±
      const testUser = await User.findOrCreate({
        where: { id: 'test_user_1' },
        defaults: {
          id: 'test_user_1',
          name: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
          level: 'Lv.1'
        }
      });

      // í…ŒìŠ¤íŠ¸ ê²Œì‹œê¸€ ìƒì„±
      const testPosts = [
        {
          title: 'ê²½ë³µê¶ ë°©ë¬¸ í›„ê¸°',
          content: 'ì˜¤ëŠ˜ ê²½ë³µê¶ì„ ë‹¤ë…€ì™”ëŠ”ë° ì •ë§ ì•„ë¦„ë‹¤ì› ìŠµë‹ˆë‹¤. íŠ¹íˆ ê·¼ì •ì „ì´ ì¸ìƒì ì´ì—ˆì–´ìš”!',
          author: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
          authorId: 'test_user_1',
          authorLevel: 'Lv.1',
          boardId: 1,
          category: 'í›„ê¸°',
          views: 15,
          likes: 3
        },
        {
          title: 'ë•ìˆ˜ê¶ ê´€ëŒ íŒ',
          content: 'ë•ìˆ˜ê¶ ê´€ëŒí•  ë•Œ ê¼­ ì•Œì•„ë‘ë©´ ì¢‹ì€ íŒë“¤ì„ ê³µìœ í•©ë‹ˆë‹¤.',
          author: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
          authorId: 'test_user_1',
          authorLevel: 'Lv.1',
          boardId: 1,
          category: 'ì •ë³´',
          views: 8,
          likes: 1
        }
      ];

      for (const postData of testPosts) {
        await Post.findOrCreate({
          where: { title: postData.title },
          defaults: postData
        });
      }

      console.log('âœ… ì»¤ë®¤ë‹ˆí‹° í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ');
      return true;
    } catch (error) {
      console.error('âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
      return false;
    }
  }
